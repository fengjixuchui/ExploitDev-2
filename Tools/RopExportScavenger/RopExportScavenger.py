#! /usr/bin/python
import sys
import pefile

if len(sys.argv) < 2:
    print("[*] Usage: [Target DLL file path] [Gadget RVA]")
    exit()

TargetFilePath=sys.argv[1]
GadgetRva = int(sys.argv[2][2:], 16)

print("Opening file at " + TargetFilePath + " to hunt for nearest export to gadget " + str(hex(GadgetRva)))

pe = pefile.PE(TargetFilePath)

if not hasattr(pe, 'DIRECTORY_ENTRY_EXPORT'):
    print("No Export table! Is this a DLL??")
    sys.exit(-1)

ExportDict = {}
RvaList = []
NearestRva = 0

for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols:
    if exp.name:
        print("%s - 0x%08x" % (exp.name.decode('utf-8'), exp.address))
        ExportDict[exp.address] = exp.name.decode('utf-8')
        RvaList.append(exp.address)
